<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile - Sports Analytics Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">
    <!-- Navigation -->
    <nav class="bg-gray-800 p-4 fixed w-full z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-8">
                <a href="/" class="text-2xl font-bold">Sports Analytics Pro</a>
                <a href="/dashboard">Dashboard</a>
            </div>
            <div class="flex items-center space-x-4">
                <span id="connectionStatus" class="text-green-500">‚óè</span>
                <button onclick="logout()" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-4 pt-24">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Profile Information -->
            <div class="md:col-span-2">
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6">Profile Information</h2>
                    <form id="profileForm" class="space-y-6">
                        <div class="flex items-center space-x-6 mb-6">
                            <div class="relative">
                                <img id="profileImage" src="/images/default-avatar.png" alt="Profile" class="w-24 h-24 rounded-full object-cover">
                                <button type="button" id="uploadPhotoBtn" class="absolute bottom-0 right-0 bg-blue-600 rounded-full p-2 hover:bg-blue-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <input type="file" id="photoInput" class="hidden" accept="image/*">
                            </div>
                            <div>
                                <h3 id="userName" class="text-xl font-bold"></h3>
                                <p id="userEmail" class="text-gray-400"></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">First Name</label>
                                <input type="text" id="firstName" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Last Name</label>
                                <input type="text" id="lastName" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Phone</label>
                                <input type="tel" id="phone" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Time Zone</label>
                                <select id="timezone" class="w-full bg-gray-700 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- Timezones will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 py-2 rounded hover:bg-blue-700">
                            Save Changes
                        </button>
                    </form>
                </div>

                <!-- API Keys -->
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">API Keys</h2>
                        <button id="generateKeyBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                            Generate New Key
                        </button>
                    </div>
                    <div id="apiKeys" class="space-y-4">
                        <!-- API keys will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Preferences -->
            <div>
                <div class="bg-gray-800 rounded-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-6">Preferences</h2>
                    <form id="preferencesForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Notifications</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="emailNotifications" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">Email Notifications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="pushNotifications" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">Push Notifications</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="smsNotifications" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">SMS Notifications</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Alert Preferences</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="gameAlerts" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">Game Alerts</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="newsAlerts" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">News Alerts</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="predictionAlerts" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">Prediction Alerts</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Display Preferences</label>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="checkbox" id="darkMode" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">Dark Mode</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="compactView" class="form-checkbox rounded bg-gray-700 border-gray-600 text-blue-500">
                                    <span class="ml-2">Compact View</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 py-2 rounded hover:bg-blue-700">
                            Save Preferences
                        </button>
                    </form>
                </div>

                <!-- Connected Accounts -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h2 class="text-2xl font-bold mb-6">Connected Accounts</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="/images/google-icon.png" alt="Google" class="w-6 h-6 mr-3">
                                <span>Google</span>
                            </div>
                            <button class="text-blue-400 hover:text-blue-300">Connect</button>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <img src="/images/twitter-icon.png" alt="Twitter" class="w-6 h-6 mr-3">
                                <span>Twitter</span>
                            </div>
                            <button class="text-blue-400 hover:text-blue-300">Connect</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load user profile
        async function loadProfile() {
            try {
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update profile information
                    document.getElementById('userName').textContent = `${data.firstName} ${data.lastName}`;
                    document.getElementById('userEmail').textContent = data.email;
                    document.getElementById('firstName').value = data.firstName || '';
                    document.getElementById('lastName').value = data.lastName || '';
                    document.getElementById('phone').value = data.phone || '';
                    
                    if (data.profileImage) {
                        document.getElementById('profileImage').src = data.profileImage;
                    }
                    
                    // Update preferences
                    document.getElementById('emailNotifications').checked = data.preferences?.emailNotifications || false;
                    document.getElementById('pushNotifications').checked = data.preferences?.pushNotifications || false;
                    document.getElementById('smsNotifications').checked = data.preferences?.smsNotifications || false;
                    document.getElementById('gameAlerts').checked = data.preferences?.gameAlerts || false;
                    document.getElementById('newsAlerts').checked = data.preferences?.newsAlerts || false;
                    document.getElementById('predictionAlerts').checked = data.preferences?.predictionAlerts || false;
                    document.getElementById('darkMode').checked = data.preferences?.darkMode || false;
                    document.getElementById('compactView').checked = data.preferences?.compactView || false;
                    
                    // Load API keys
                    if (data.apiKeys) {
                        const apiKeysContainer = document.getElementById('apiKeys');
                        apiKeysContainer.innerHTML = data.apiKeys.map(key => `
                            <div class="flex items-center justify-between bg-gray-700 p-4 rounded">
                                <div>
                                    <div class="font-medium">${key.name}</div>
                                    <div class="text-sm text-gray-400">Created: ${new Date(key.createdAt).toLocaleDateString()}</div>
                                </div>
                                <button class="text-red-400 hover:text-red-300" onclick="revokeApiKey('${key.id}')">
                                    Revoke
                                </button>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('error', 'Failed to load profile');
            }
        }

        // Save profile changes
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        phone: document.getElementById('phone').value,
                        timezone: document.getElementById('timezone').value
                    })
                });
                
                if (response.ok) {
                    showToast('success', 'Profile updated successfully');
                } else {
                    throw new Error('Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('error', error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Save Changes';
            }
        });

        // Save preferences
        document.getElementById('preferencesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Saving...';
            
            try {
                const response = await fetch('/api/user/preferences', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        emailNotifications: document.getElementById('emailNotifications').checked,
                        pushNotifications: document.getElementById('pushNotifications').checked,
                        smsNotifications: document.getElementById('smsNotifications').checked,
                        gameAlerts: document.getElementById('gameAlerts').checked,
                        newsAlerts: document.getElementById('newsAlerts').checked,
                        predictionAlerts: document.getElementById('predictionAlerts').checked,
                        darkMode: document.getElementById('darkMode').checked,
                        compactView: document.getElementById('compactView').checked
                    })
                });
                
                if (response.ok) {
                    showToast('success', 'Preferences updated successfully');
                } else {
                    throw new Error('Failed to update preferences');
                }
            } catch (error) {
                console.error('Error updating preferences:', error);
                showToast('error', error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Save Preferences';
            }
        });

        // Handle profile photo upload
        document.getElementById('uploadPhotoBtn').addEventListener('click', () => {
            document.getElementById('photoInput').click();
        });

        document.getElementById('photoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch('/api/user/profile-photo', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('profileImage').src = data.photoUrl;
                    showToast('success', 'Profile photo updated successfully');
                } else {
                    throw new Error('Failed to update profile photo');
                }
            } catch (error) {
                console.error('Error updating profile photo:', error);
                showToast('error', error.message);
            }
        });

        // Generate API key
        document.getElementById('generateKeyBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/user/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    loadProfile(); // Reload profile to show new key
                    showToast('success', 'API key generated successfully');
                } else {
                    throw new Error('Failed to generate API key');
                }
            } catch (error) {
                console.error('Error generating API key:', error);
                showToast('error', error.message);
            }
        });

        // Revoke API key
        async function revokeApiKey(keyId) {
            if (!confirm('Are you sure you want to revoke this API key?')) return;

            try {
                const response = await fetch(`/api/user/api-keys/${keyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    loadProfile(); // Reload profile to update keys list
                    showToast('success', 'API key revoked successfully');
                } else {
                    throw new Error('Failed to revoke API key');
                }
            } catch (error) {
                console.error('Error revoking API key:', error);
                showToast('error', error.message);
            }
        }

        // Toast notification system
        function showToast(type, message) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Populate timezone select
        function populateTimezones() {
            const timezones = moment.tz.names();
            const select = document.getElementById('timezone');
            timezones.forEach(timezone => {
                const option = document.createElement('option');
                option.value = timezone;
                option.textContent = timezone;
                select.appendChild(option);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            populateTimezones();
        });

        function logout() {
            localStorage.clear();
            window.location.href = '/login';
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data.min.js"></script>
</body>
</html>